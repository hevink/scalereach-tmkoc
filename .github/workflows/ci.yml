name: CI/CD

on:
  push:
    branches: [main, feature/split-screen-clips]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€ Type check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.19"
      - run: bun install
      - run: bun run build

  # â”€â”€ Build verification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [typecheck]
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.19"
      - run: bun install
      - run: bun build src/index.ts --outdir ./dist --target bun
      - run: bun build src/worker.ts --outdir ./dist --target bun

  # â”€â”€ Deploy API â†’ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-api:
    name: Deploy API to Render
    runs-on: ubuntu-latest
    needs: [build-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Trigger Render deploy
        run: |
          curl -s -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -o /dev/null -w "HTTP %{http_code}\n"

  # â”€â”€ Deploy Worker â†’ EC2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-worker:
    name: Deploy Worker to EC2
    runs-on: ubuntu-latest
    needs: [build-check]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature/split-screen-clips')
    steps:
      - name: Deploy worker via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            export PATH="/home/ubuntu/.bun/bin:$PATH"
            cd /opt/scalereach

            echo "ğŸ“¦ Pulling latest code..."
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            echo "ğŸ“¦ Installing dependencies..."
            bun install

            echo "ğŸ”„ Reloading worker..."
            pm2 reload ecosystem.config.cjs --update-env || pm2 start ecosystem.config.cjs

            pm2 save
            echo "âœ… Worker deploy complete"
            pm2 status

            echo "ğŸ¥ Health check..."
            sleep 3
            curl -sf http://localhost:3002/health | grep -q '"status":"healthy"' && echo "âœ… Health OK" || echo "âš ï¸ Health check failed"
