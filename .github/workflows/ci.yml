name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€ Build verification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref_name }}
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2.19"
      - run: bun install
      - run: bun build src/index.ts --outdir ./dist --target bun
      - run: bun build src/worker.ts --outdir ./dist --target bun

  # â”€â”€ Deploy Worker â†’ EC2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-worker:
    name: Deploy Worker to EC2
    runs-on: ubuntu-latest
    needs: [build-check]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy worker via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            export PATH="/home/ubuntu/.bun/bin:/usr/bin:/usr/local/bin:$PATH"
            cd /opt/scalereach

            # Save current commit for rollback
            PREV_COMMIT=$(git rev-parse HEAD)
            echo "ğŸ“Œ Current commit: $PREV_COMMIT"

            echo "ğŸ“¦ Pulling latest code..."
            git fetch origin
            git checkout main
            git reset --hard origin/main

            NEW_COMMIT=$(git rev-parse HEAD)
            echo "ğŸ†• New commit: $NEW_COMMIT"

            echo "ğŸ“¦ Installing dependencies..."
            bun install

            echo "ğŸ”„ Reloading worker..."
            pm2 reload ecosystem.config.cjs --update-env || pm2 start ecosystem.config.cjs
            pm2 save

            echo "ğŸ¥ Health check (waiting 15s)..."
            sleep 15
            if curl -sf http://localhost:3002/health | grep -q '"status".*"healthy"'; then
              echo "âœ… Deploy successful â€” $NEW_COMMIT"
              pm2 status
            else
              echo "âŒ Health check failed â€” rolling back to $PREV_COMMIT"
              git checkout main
              git reset --hard $PREV_COMMIT
              bun install
              pm2 reload ecosystem.config.cjs --update-env || pm2 start ecosystem.config.cjs
              sleep 5
              if curl -sf http://localhost:3002/health | grep -q '"status".*"healthy"'; then
                echo "âœ… Rollback successful â€” running $PREV_COMMIT"
              else
                echo "ğŸš¨ Rollback also failed â€” manual intervention required"
              fi
              exit 1
            fi
