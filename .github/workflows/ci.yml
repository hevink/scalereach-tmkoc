name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€ Type check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install
      - run: bun run build

  # â”€â”€ Build verification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [typecheck]
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - run: bun install
      - run: bun build src/index.ts --outdir ./dist --target bun
      - run: bun build src/worker.ts --outdir ./dist --target bun

  # â”€â”€ Deploy API â†’ Render (auto via git push) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Render watches the main branch and deploys automatically.
  # No extra step needed here â€” just trigger it via the deploy hook
  # if you want explicit control.
  deploy-api:
    name: Deploy API to Render
    runs-on: ubuntu-latest
    needs: [build-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Trigger Render deploy
        run: |
          curl -s -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -o /dev/null -w "HTTP %{http_code}\n"

  # â”€â”€ Deploy Worker â†’ EC2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-worker:
    name: Deploy Worker to EC2
    runs-on: ubuntu-latest
    needs: [build-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Deploy worker via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /opt/scalereach

            echo "ðŸ“¦ Pulling latest code..."
            git pull origin main

            echo "ðŸ“¦ Installing dependencies..."
            bun install --frozen-lockfile

            echo "ðŸ”„ Reloading worker..."
            pm2 reload ecosystem.config.cjs --update-env || pm2 start ecosystem.config.cjs

            pm2 save
            echo "âœ… Worker deploy complete"
            pm2 status
